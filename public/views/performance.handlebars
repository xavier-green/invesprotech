<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>
<script src="/assets/js/nv.d3.min.js"></script>

<script>
 jQuery(document).ready(function(){
   $(".select2").select2();
   $('#date-range').datepicker({
      toggleActive: true
   });
   $("#portfolioIds").on('change', function() {
    const portfolioIds = $(this).val();
    $("#disapear").show();
    $("#disapear").text("Chargement...");

    console.log(portfolioIds);
    if (portfolioIds == null) {
      $("#chart").hide()
      $("#disapear").text("Veuillez selectionner un portfolio.");
    } else {
      $.ajax({
        url: "/api/portfolio_history",
        type: "post",
        data: JSON.stringify({ "ids": portfolioIds }),
        contentType : 'application/json',
        success: function(portfolioData) {
          console.log(portfolioData.stats);
          if (portfolioData.historicData.length>0) {
            $("#chart").show()
            $("#investedAmount").text(portfolioData.stats.totalInvested);
            $("#earnedAmount").text(portfolioData.stats.totalEarned);
            $("#protectedAmount").text(portfolioData.stats.totalProtected);
            showData(portfolioData.historicData)
            $("#disapear").hide();
          } else {
            $("#disapear").text("Veuillez créer un portfolio et faire un investissement pour voir vos performances !");
          }
          
        }
      });
    }
   })

   function showData(data) {

      var width = 850,
          height = 500;

      nv.addGraph(function() {

        var chart = nv.models.lineChart()
          .interactive(false)
          .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
          .showYAxis(true)        //Show the y-axis
          .showXAxis(true)
          .width(width)
          .height(height);

        chart.xAxis
            .axisLabel("Temps")
            .showMaxMin(false)
            .tickFormat(function(d) { return d3.time.format('%m/%d/%y')(new Date(d)); });

        chart.yAxis
            .axisLabel("Valorisation")
            .tickFormat(d3.format("d"))
            ;

        d3.select('#chart svg')
          .datum(data)
          .attr('width', width)
          .attr('height', height)
          .call(chart)
          ;

        nv.utils.windowResize(chart.update);

      return chart;

    });

  }

 });
 </script>

 <div class="row">
   <div class="col-sm-12">
     <h4 class="page-title">Performance</h4>
   </div>
 </div>

 <div class="row">
   <div class="col-lg-12">
     <div class="card-box">

       <div class="row">
         <div class="col-md-4">
           <select id="portfolioIds" class="select2 select2-multiple" multiple="multiple" multiple data-placeholder="Choisir ...">
             {{#each user.portfolios}}
               <option value="{{_id._id}}">{{name}}</option>
             {{/each}}
           </select>
           <span class="help-block"><small>Portfolios</small></span>
         </div>
         <div class="col-md-8">
           <div class="input-daterange input-group" id="date-range">
               <input type="text" class="form-control" name="start" placeholder="Début"/>
               <span class="input-group-addon bg-primary b-0 text-white">jusqu'à</span>
               <input type="text" class="form-control" name="end" placeholder="Fin"/>
           </div>
           <span class="help-block"><small>Période d'étude souhaitée</small></span>
         </div>
       </div>

       <div class="row">
         <div class="col-sm-12">
           <div class="card-box">
             <div class="row">
               <div class="col-md-4 col-sm-12">
                 <div class="card-box widget-user">
                   <div class="text-center">
                     <h2 class="text-success"><span id="investedAmount">0.00</span> €</h2>
                     <h5>Montant total investi</h5>
                   </div>
                 </div>
               </div>
               <div class="col-md-4 col-sm-12">
                 <div class="card-box widget-user">
                   <div class="text-center">
                     <h2 class="text-warning"><span id="earnedAmount">0.00</span> €</h2>
                     <h5>Gains totaux</h5>
                   </div>
                 </div>
               </div>
               <div class="col-md-4 col-sm-12">
                 <div class="card-box widget-user">
                   <div class="text-center">
                     <h2 class="text-primary"><span id="protectedAmount">0.00</span> €</h2>
                     <h5>Gains protégés</h5>
                   </div>
                 </div>
               </div>
             </div>
           </div>
         </div><!-- end col -->
       </div>
       <!-- end row -->

       <div class="row" style="width:100%; text-align: center;">
         <h2 id="disapear" class="text-center">Veuillez selectionner un portfolio.</h2>
          <div id="chart" style="width:850px;display: inline-block;">
            <svg></svg>
          </div>
       </div>
     </div>
   </div><!-- end col -->
 </div>
